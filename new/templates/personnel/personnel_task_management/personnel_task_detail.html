{% extends "personnel/personnel_base_dashboard.html" %}
{% block title %}Task Detail{% endblock %}

{% load custom_tags %}



{% block page_header %}
<h1 class="page-title mb-0">Task Details</h1>
{% endblock %}

{% block page_filter %}
<form method="get" class="d-flex gap-2 align-items-center flex-wrap">
  <a href="{% url 'gso_requests:personnel_task_management' %}" class="btn btn-secondary">
    Back
  </a>
</form>
{% endblock %}





{% block main_content %}

<!-- ===== TASK INFORMATION ===== -->
<div class="card shadow-sm border-0 rounded-4 mb-4">
  <div class="card-header text-white fw-semibold rounded-top-4" style="background-color: #002e72;">
    <i class="bi bi-info-circle me-2"></i> Task Information
  </div>
  <div class="card-body p-4">
    <div class="row g-4">
      <!-- Left Column -->
      <div class="col-md-6">
        <div class="d-flex flex-column gap-2 small">
          <p><strong>Request ID:</strong> <span class="text-dark fw-semibold">#{{ task.id }}</span></p>
          <p><strong>Date Submitted:</strong> {{ task.created_at|date:"Y-m-d H:i" }}</p>
          <p><strong>Requestor:</strong> {{ task.custom_full_name }}</p>
          <p><strong>Requesting Office:</strong> {{ task.requestor.department }}</p>
          <p><strong>Unit:</strong> {{ task.unit|title }}</p>
          <p>
            <strong>Attachment:</strong><br>
            {% if task.attachment %}
              <a href="{{ task.attachment.url }}" target="_blank">
                <img src="{{ task.attachment.url }}" alt="Attachment"
                     class="img-thumbnail mt-2" style="max-width: 200px; border-radius: 8px;">
              </a>
            {% else %}
              <span class="text-muted">No attachment provided.</span>
            {% endif %}
          </p>

          <!-- ===== ASSIGNED MATERIALS INSIDE TASK INFO ===== -->
          <p>
            <strong>Assigned Materials:</strong><br>
            {% if task.requestmaterial_set.all %}
              <ul class="list-unstyled ps-3 mb-0">
                {% for rm in task.requestmaterial_set.all %}
                  <li>
                    <i class="bi bi-box-seam text-primary"></i>
                    {{ rm.material.name }} â€“ {{ rm.quantity }} {{ rm.material.unit }}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <span class="text-muted">No materials assigned yet.</span>
            {% endif %}
          </p>
          <!-- ===== END ASSIGNED MATERIALS ===== -->

        </div>
      </div>

      <!-- Right Column -->
      <div class="col-md-6 border-start ps-4">
        <div class="mb-3">
          <strong>Status:</strong>
          <span class="badge fs-6 px-3 py-2 rounded-pill
            {% if task.status == 'Pending' %} bg-warning text-dark
            {% elif task.status == 'Approved' %} bg-info text-dark
            {% elif task.status == 'In Progress' %} bg-primary
            {% elif task.status == 'Done for Review' %} bg-secondary
            {% elif task.status == 'Completed' %} bg-success
            {% elif task.status == 'Cancelled' %} bg-danger
            {% else %} bg-light text-dark {% endif %}">
            {{ task.status }}
          </span>
        </div>

        <div class="mb-3">
          <strong>Description:</strong>
          <div class="p-3 mt-2 border rounded-3 bg-light text-dark small">
            {{ task.description|default:"No description provided." }}
          </div>
        </div>

        {% if task.status in "Approved,In Progress" %}
        <form method="post" class="mt-2">
          {% csrf_token %}
          <label for="success_indicator" class="fw-semibold text-secondary">Success Indicator:</label>
          <select name="success_indicator" id="success_indicator" class="form-select mb-3 shadow-sm">
            <option value="">-- Select Success Indicator --</option>
            {% for si in indicators %}
              <option value="{{ si.id }}" {% if task.selected_indicator_id == si.id %}selected{% endif %}>
                {{ si.code }}
              </option>
            {% endfor %}
          </select>
          <div class="d-flex justify-content-end">
            <button type="submit" name="save_indicator" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-save me-1"></i> Save Indicator
            </button>
          </div>
        </form>
        {% endif %}
      </div>
    </div>

    <!-- Task Action Buttons -->
    {% if task.status in "Approved,In Progress" %}
    <div class="d-flex justify-content-end mt-4">
      <form method="post" class="d-flex gap-2">
        {% csrf_token %}
        {% if task.status == "Approved" %}
          <button type="submit" name="start" class="btn btn-primary px-4">
            <i class="bi bi-play-fill me-1"></i> Start Task
          </button>
        {% elif task.status == "In Progress" %}
          <button type="submit" name="done" class="btn btn-success px-4">
            <i class="bi bi-check2-circle me-1"></i> Mark as Done
          </button>
        {% endif %}
      </form>
    </div>
    {% endif %}
  </div>
</div>

<!-- ===== MATERIAL ASSIGNMENT FORM ===== -->
{% if task.status == "In Progress" %}
<form method="post" class="mb-4">
  {% csrf_token %}
  <input type="hidden" name="form_type" value="assign_materials">

  <div class="card shadow-sm border-0 rounded-4 mb-4">
    <div class="card-header text-white fw-bold" style="background-color: #002e72;">
      <i class="bi bi-box-seam me-2"></i> Select Materials
    </div>

    <div class="card-body" style="max-height: 350px; overflow-y: auto;">
      {% if available_materials %}
        <div class="table-responsive">
          <table class="table align-middle table-sm mb-0">
            <thead class="table-light">
              <tr>
                <th></th>
                <th>Material</th>
                <th>Available</th>
                <th>Quantity to Use</th>
              </tr>
            </thead>
            <tbody>
              {% for m in available_materials %}
                {% with assigned_qty=assigned_materials|get_item:m.id %}
                <tr>
                  <td class="text-center">
                    <input 
                      type="checkbox" 
                      name="material_ids" 
                      value="{{ m.id }}" 
                      id="material_{{ m.id }}" 
                      class="form-check-input material-checkbox"
                      {% if assigned_qty %}checked{% endif %}>
                  </td>
                  <td>
                    <label for="material_{{ m.id }}" class="mb-0 fw-semibold">{{ m.name }}</label>
                  </td>
                  <td class="text-muted small">{{ m.quantity }} {{ m.unit }}</td>
                  <td>
                    <input 
                      type="number" 
                      name="quantity_{{ m.id }}" 
                      value="{{ assigned_qty|default:'' }}" 
                      min="1" 
                      class="form-control form-control-sm text-center material-qty"
                      style="max-width: 90px;"
                      {% if not assigned_qty %}disabled{% endif %}>
                  </td>
                </tr>
                {% endwith %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">No materials available.</p>
      {% endif %}
    </div>

    <!-- Move the Save Materials button inside the card -->
    <div class="card-footer d-flex justify-content-end bg-light border-0">
      <button type="submit" name="action" value="assign_materials" class="btn btn-success px-4">
        <i class="bi bi-box-arrow-down me-1"></i> Save Materials
      </button>
    </div>
  </div>
</form>
{% endif %}


<!-- ===== PROGRESS REPORTS SECTION ===== -->
<div class="card shadow-sm border-0 rounded-4">
  <div class="card-header text-white fw-bold" style="background-color: #002e72;">
    <i class="bi bi-clipboard-check me-2"></i> Progress Reports
  </div>

  <div class="card-body">
    {% if reports %}
      <ul class="list-group mb-4">
        {% for r in reports %}
        <li class="list-group-item border-0 border-bottom">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>{{ r.personnel.get_full_name|default:r.personnel.username }}</strong>
              <p class="mb-1 mt-1">{{ r.report_text }}</p>
            </div>
            <small class="text-muted">{{ r.created_at|date:"Y-m-d H:i" }}</small>
          </div>
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">No reports submitted yet.</p>
    {% endif %}

    {% if task.status == "In Progress" %}
    <form method="post" class="mt-3">
      {% csrf_token %}
      <div class="mb-3">
        <textarea 
          name="report_text" 
          class="form-control shadow-sm" 
          rows="3" 
          placeholder="Write your progress report here..."></textarea>
      </div>
      <div class="d-flex justify-content-end">
        <button type="submit" name="add_report" class="btn btn-success px-4">
          <i class="bi bi-save"></i> Save Report
        </button>
      </div>
    </form>
    {% endif %}
  </div>
</div>

<!-- ===== MATERIAL CHECK JS ===== -->
<script>
  document.querySelectorAll('.material-checkbox').forEach((checkbox) => {
    const row = checkbox.closest('tr');
    const qtyInput = row.querySelector('.material-qty');
    const availableQty = parseInt(row.querySelector('td:nth-child(3)').innerText) || 0;

    qtyInput.disabled = !checkbox.checked;

    checkbox.addEventListener('change', () => {
      if (checkbox.checked) {
        qtyInput.disabled = false;
        if (!qtyInput.value) qtyInput.value = 1;
      } else {
        qtyInput.disabled = true;
        qtyInput.value = "";
      }
    });

    qtyInput.addEventListener('input', () => {
      const val = parseInt(qtyInput.value);
      if (val > availableQty) {
        qtyInput.value = availableQty;
        alert(`Cannot use more than available stock (${availableQty})`);
      } else if (val < 1 || isNaN(val)) {
        qtyInput.value = 1;
      }
    });
  });
</script>
{% endblock %}
