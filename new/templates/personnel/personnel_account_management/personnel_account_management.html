{% extends "personnel/personnel_base_dashboard.html" %}

{% block title %}Account Management{% endblock %}

{% block main_content %}

<div class="header d-flex align-items-center justify-content-between mb-3">
  <h1 class="page-title">ACCOUNT MANAGEMENT</h1>
</div>

<!-- Profile Card -->
<div class="content-card p-4 rounded-3 shadow-sm bg-white">
  <form method="post" id="profileForm">
    {% csrf_token %}
    <input type="hidden" name="update_profile" value="1">

    <h5 class="fw-bold mb-3">Profile Information</h5>

    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label text-secondary fw-semibold">Full Name</label>
        <input type="text" class="form-control" name="full_name"
               value="{{ user.get_full_name|default:user.username }}" readonly>
      </div>
      <div class="col-md-6">
        <label class="form-label text-secondary fw-semibold">Username</label>
        <input type="text" class="form-control" value="{{ user.username }}" readonly>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label text-secondary fw-semibold">Email</label>
        <input type="email" class="form-control" name="email" value="{{ user.email }}" readonly>
      </div>
    </div>

    <div class="text-end mt-3">
      <button type="button" id="editBtn" class="btn btn-primary rounded-pill px-4">Edit Profile</button>
      <button type="submit" id="saveBtn" class="btn btn-success rounded-pill px-4 d-none">Save</button>
      <button type="button" id="cancelBtn" class="btn btn-secondary rounded-pill px-4 d-none">Cancel</button>
      <button type="button" id="showPasswordBtn" class="btn btn-warning rounded-pill px-4 ms-2">Change Password</button>
    </div>
  </form>
</div>

<!-- Password Change Card -->
<div class="content-card p-4 rounded-3 shadow-sm bg-white mt-4 {% if form.errors %}{% else %}d-none{% endif %}" id="passwordCard">
  <h5 class="fw-bold mb-3">Change Password</h5>
  <p class="text-muted small mb-4">You can update your password anytime to keep your account secure.</p>

  <form method="post" id="passwordForm">
    {% csrf_token %}
    <input type="hidden" name="change_password" value="1">

    <!-- Current Password -->
    <div class="mb-3 position-relative">
      <label for="id_old_password" class="form-label fw-semibold text-secondary">Current Password</label>
      <input type="password" name="old_password" id="id_old_password" class="form-control pe-5" required>
      <i class="bi bi-eye-slash toggle-password position-absolute top-50 end-0 translate-middle-y me-3"
         data-target="id_old_password" style="cursor:pointer;"></i>
      {% if form.old_password.errors %}
        <div class="text-danger small">{{ form.old_password.errors }}</div>
      {% endif %}
    </div>

    <!-- New Password -->
    <div class="mb-3 position-relative">
      <label for="id_new_password1" class="form-label fw-semibold text-secondary">New Password</label>
      <input type="password" name="new_password1" id="id_new_password1" class="form-control pe-5" required>
      <i class="bi bi-eye-slash toggle-password position-absolute top-50 end-0 translate-middle-y me-3"
         data-target="id_new_password1" style="cursor:pointer;"></i>
      {% if form.new_password1.errors %}
        <div class="text-danger small">{{ form.new_password1.errors }}</div>
      {% endif %}
    </div>

    <!-- Confirm New Password -->
    <div class="mb-3 position-relative">
      <label for="id_new_password2" class="form-label fw-semibold text-secondary">Confirm New Password</label>
      <input type="password" name="new_password2" id="id_new_password2" class="form-control pe-5" required>
      <i class="bi bi-eye-slash toggle-password position-absolute top-50 end-0 translate-middle-y me-3"
         data-target="id_new_password2" style="cursor:pointer;"></i>
      {% if form.new_password2.errors %}
        <div class="text-danger small">{{ form.new_password2.errors }}</div>
      {% endif %}
    </div>

    <div class="text-end">
      <button type="button" id="cancelPasswordBtn" class="btn btn-secondary rounded-pill px-4 me-2">Cancel</button>
      <button type="submit" class="btn btn-warning rounded-pill px-4">Update Password</button>
    </div>
  </form>
</div>

<!-- Inline Scripts -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const editBtn = document.getElementById("editBtn");
  const saveBtn = document.getElementById("saveBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const showPasswordBtn = document.getElementById("showPasswordBtn");
  const passwordCard = document.getElementById("passwordCard");
  const cancelPasswordBtn = document.getElementById("cancelPasswordBtn");
  const form = document.getElementById("profileForm");
  const inputs = form.querySelectorAll("input[readonly]");

  // Profile edit mode
  editBtn.addEventListener("click", () => {
    inputs.forEach(i => i.removeAttribute("readonly"));
    editBtn.classList.add("d-none");
    saveBtn.classList.remove("d-none");
    cancelBtn.classList.remove("d-none");
  });

  cancelBtn.addEventListener("click", () => {
    window.location.reload();
  });

  // Toggle password section
  showPasswordBtn.addEventListener("click", () => {
    passwordCard.classList.remove("d-none");
    showPasswordBtn.classList.add("d-none");
  });

  cancelPasswordBtn.addEventListener("click", () => {
    passwordCard.classList.add("d-none");
    showPasswordBtn.classList.remove("d-none");
  });

  // Show/hide password icons
  document.querySelectorAll(".toggle-password").forEach(icon => {
    icon.addEventListener("click", () => {
      const targetId = icon.getAttribute("data-target");
      const input = document.getElementById(targetId);
      if (input.type === "password") {
        input.type = "text";
        icon.classList.remove("bi-eye-slash");
        icon.classList.add("bi-eye");
      } else {
        input.type = "password";
        icon.classList.remove("bi-eye");
        icon.classList.add("bi-eye-slash");
      }
    });
  });
});
</script>

{% if form.errors %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Keep password section open if errors exist
    document.getElementById("passwordCard").classList.remove("d-none");
    document.getElementById("showPasswordBtn").classList.add("d-none");
  });
</script>
{% endif %}

<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

{% endblock %}
